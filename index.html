<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Strawberry Cream Cake — Blow Out 23 Candles</title>
  <style>
    :root{--bg:#fff7f8;--cake:#f6c3ca;--frost:#ffeff2;--plate:#fff;--straw:#d94b6a}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,-apple-system,Arial}
    body{display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#fff 0%,#ffeef2 60%);padding:24px}
    .wrap{width:100%;max-width:900px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    h1{font-size:20px;margin:0;color:#6b2430}
    .controls{display:flex;gap:8px;align-items:center}
    button{background:#6b2430;color:white;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    button.secondary{background:transparent;border:2px solid #6b2430;color:#6b2430}
    .vis{display:flex;gap:12px;align-items:center}
    .meter{width:160px;height:10px;background:#ffe6ea;border-radius:10px;overflow:hidden}
    .meter > div{height:100%;width:0%;background:linear-gradient(90deg,#ff8aa0,#d94b6a)}
    .stage{background:transparent;padding:18px;border-radius:16px;display:flex;align-items:center;justify-content:center}
    /* cake area */
    .cake-wrap{position:relative;width:720px;height:420px}
    svg{width:100%;height:100%}

    /* small helpers */
    .note{font-size:12px;color:#5a2b32;margin-left:8px}
    .footer{margin-top:10px;color:#6b2430;font-size:13px}

    /* flame fade */
    .flame{transition:opacity 650ms ease, transform 650ms ease}
    .smoke{opacity:0;transition:opacity 400ms ease 200ms}
    .extinguished .flame{opacity:0;transform:translateY(-4px) scale(0.8)}
    .extinguished .smoke{opacity:1}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Strawberry Cream Cake — Sendable demo (23 candles)</h1>
      <div class="controls">
        <div class="vis">
          <div class="meter" id="meter"><div></div></div>
          <div class="note" id="volTxt">vol: 0</div>
        </div>
        <button id="startBtn">Enable Microphone</button>
        <button id="testBlow" class="secondary">Test Blow (click)</button>
      </div>
    </header>

    <section class="stage">
      <div class="cake-wrap" id="cakeWrap">
        <!-- SVG generated by JS -->
      </div>
    </section>

    <div class="footer">Instructions: click <strong>Enable Microphone</strong> and blow toward your device's mic. On sufficient volume the candles will be extinguished. Works locally in modern browsers (Chrome, Edge, Firefox on desktop & mobile). No audio leaves your device.</div>
  </div>

<script>
// Configuration
const NUM_CANDLES = 23;
const BLOW_THRESHOLD = 0.08; // amplitude mean threshold (tweakable)
const BLOW_DURATION_MS = 350; // how long the loudness must exceed threshold

// Helpers to create SVG cake + candles
function createCakeSVG() {
  const ns = 'http://www.w3.org/2000/svg';
  const svg = document.createElementNS(ns,'svg');
  svg.setAttribute('viewBox','0 0 900 520');
  svg.setAttribute('preserveAspectRatio','xMidYMid meet');

  // background plate shadow
  const plate = document.createElementNS(ns,'ellipse');
  plate.setAttribute('cx',450); plate.setAttribute('cy',420);
  plate.setAttribute('rx',300); plate.setAttribute('ry',28);
  plate.setAttribute('fill','rgba(0,0,0,0.06)');
  svg.appendChild(plate);

  // cake body (two tiers)
  const tier1 = document.createElementNS(ns,'rect');
  tier1.setAttribute('x',160); tier1.setAttribute('y',240);
  tier1.setAttribute('rx',30); tier1.setAttribute('ry',30);
  tier1.setAttribute('width',580); tier1.setAttribute('height',160);
  tier1.setAttribute('fill','var(--cake)');
  tier1.setAttribute('stroke','rgba(0,0,0,0.06)');
  svg.appendChild(tier1);

  const cream = document.createElementNS(ns,'path');
  cream.setAttribute('d', 'M140 260 q40 -40 100 0 t120 0 t140 0 t120 0 t50 0 v12 h-540 z');
  cream.setAttribute('fill','var(--frost)');
  svg.appendChild(cream);

  // strawberries on top
  for (let i=0;i<8;i++){
    const x = 200 + i*80 + (i%2?10:-10);
    const y = 250;
    const berry = document.createElementNS(ns,'ellipse');
    berry.setAttribute('cx',x); berry.setAttribute('cy',y);
    berry.setAttribute('rx',16); berry.setAttribute('ry',22);
    berry.setAttribute('fill','#e94a6b');
    svg.appendChild(berry);
    const leaf = document.createElementNS(ns,'path');
    leaf.setAttribute('d',`M${x-6} ${y-6} q8 -12 14 0 q-8 -6 -14 0`);
    leaf.setAttribute('fill','#2b7a3b');
    svg.appendChild(leaf);
  }

  // create a group for candles
  const candlesGroup = document.createElementNS(ns,'g');
  candlesGroup.setAttribute('id','candlesGroup');
  svg.appendChild(candlesGroup);

  // smoke definition
  const defs = document.createElementNS(ns,'defs');
  const filter = document.createElementNS(ns,'filter'); filter.setAttribute('id','f1');
  const fe = document.createElementNS(ns,'feGaussianBlur'); fe.setAttribute('stdDeviation','2');
  filter.appendChild(fe); defs.appendChild(filter); svg.appendChild(defs);

  return svg;
}

function placeCandles(svg, count){
  const g = svg.querySelector('#candlesGroup');
  g.innerHTML = '';
  const cakeLeft = 200; const cakeRight = 700; const y = 230;
  for (let i=0;i<count;i++){
    const t = i/(count-1);
    const x = cakeLeft + (cakeRight - cakeLeft)*t + (Math.sin(i*1.4)*6);
    const candle = createCandle(x,y,i);
    g.appendChild(candle);
  }
}

function createCandle(x,y,index){
  const ns='http://www.w3.org/2000/svg';
  const g = document.createElementNS(ns,'g');
  g.setAttribute('class','candle');
  g.setAttribute('data-index',index);
  g.setAttribute('transform',`translate(${x},${y})`);

  // stick
  const rect = document.createElementNS(ns,'rect');
  rect.setAttribute('x',-6); rect.setAttribute('y',-48); rect.setAttribute('width',12); rect.setAttribute('height',40);
  rect.setAttribute('rx',3); rect.setAttribute('fill','#fff'); rect.setAttribute('stroke','#f0d0d3');
  g.appendChild(rect);

  // wax stripes
  const stripe = document.createElementNS(ns,'rect');
  stripe.setAttribute('x',-6); stripe.setAttribute('y',-48); stripe.setAttribute('width',12); stripe.setAttribute('height',12);
  stripe.setAttribute('fill','var(--straw)'); stripe.setAttribute('opacity',0.18);
  g.appendChild(stripe);

  // flame group
  const flameG = document.createElementNS(ns,'g');
  flameG.setAttribute('class','flameWrap');

  const flame = document.createElementNS(ns,'ellipse');
  flame.setAttribute('cx',0); flame.setAttribute('cy',-56); flame.setAttribute('rx',7); flame.setAttribute('ry',10);
  flame.setAttribute('fill','url(#grad'+index+')'); flame.setAttribute('class','flame');
  // gradient for flame
  const defs = document.createElementNS(ns,'defs');
  const grad = document.createElementNS(ns,'radialGradient'); grad.setAttribute('id','grad'+index);
  const stop1 = document.createElementNS(ns,'stop'); stop1.setAttribute('offset','0%'); stop1.setAttribute('stop-color','#fff6b8');
  const stop2 = document.createElementNS(ns,'stop'); stop2.setAttribute('offset','50%'); stop2.setAttribute('stop-color','#ffd06b');
  const stop3 = document.createElementNS(ns,'stop'); stop3.setAttribute('offset','100%'); stop3.setAttribute('stop-color','#ff6b6b');
  grad.appendChild(stop1); grad.appendChild(stop2); grad.appendChild(stop3);
  defs.appendChild(grad);
  g.appendChild(defs);

  flameG.appendChild(flame);

  // smoke
  const smoke = document.createElementNS(ns,'ellipse');
  smoke.setAttribute('cx',0); smoke.setAttribute('cy',-70); smoke.setAttribute('rx',2); smoke.setAttribute('ry',6);
  smoke.setAttribute('fill','rgba(80,80,80,0.18)'); smoke.setAttribute('class','smoke');
  flameG.appendChild(smoke);

  g.appendChild(flameG);

  return g;
}

// Insert SVG into page
const cakeWrap = document.getElementById('cakeWrap');
const svg = createCakeSVG();
placeCandles(svg, NUM_CANDLES);
cakeWrap.appendChild(svg);

// Microphone handling & blow detection
let audioCtx, analyser, source, dataArray, rafId;
let lastLoud = 0;
let blowTimer = null;
let isExtinguished = false;
const meterBar = document.querySelector('#meter > div');
const volTxt = document.getElementById('volTxt');

async function enableMic() {
  if (audioCtx) return;
  try {
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    source = audioCtx.createMediaStreamSource(stream);
    analyser = audioCtx.createAnalyser(); analyser.fftSize = 2048;
    source.connect(analyser);
    dataArray = new Uint8Array(analyser.fftSize);
    monitor();
  } catch (e) {
    alert('Microphone access is required for blow detection.\nError: '+e.message);
  }
}

function getRMS(arr){
  let sum = 0;
  for (let i=0;i<arr.length;i++){ const v = (arr[i]-128)/128; sum += v*v; }
  return Math.sqrt(sum/arr.length);
}

function monitor(){
  analyser.getByteTimeDomainData(dataArray);
  const rms = getRMS(dataArray);
  // update UI
  meterBar.style.width = Math.min(100, Math.round(rms*1000))/10 + '%';
  volTxt.textContent = 'vol: ' + rms.toFixed(3);

  if (!isExtinguished && rms > BLOW_THRESHOLD){
    if (!blowTimer) blowTimer = Date.now();
    else if (Date.now() - blowTimer > BLOW_DURATION_MS){
      triggerBlow();
      blowTimer = null;
    }
  } else {
    blowTimer = null;
  }
  rafId = requestAnimationFrame(monitor);
}

function triggerBlow(){
  if (isExtinguished) return;
  isExtinguished = true;
  // add extinguish class to svg root (for transitions)
  svg.classList.add('extinguished');
  // individually hide flames and show smoke (extra effect)
  const flames = svg.querySelectorAll('.flame');
  flames.forEach((f,i)=>{
    f.style.opacity = '0';
    f.style.transform = 'translateY(-6px) scale(0.9)';
  });
  const smokes = svg.querySelectorAll('.smoke');
  smokes.forEach((s,i)=>{ s.style.opacity = '1'; s.setAttribute('ry', 14); s.setAttribute('rx', 6); s.style.transform = 'translateY(-12px)'; });
  // small puff animation
  playPuff();
}

function playPuff(){
  // quick SVG puff circle
  const ns='http://www.w3.org/2000/svg';
  const puff = document.createElementNS(ns,'circle');
  puff.setAttribute('cx',450); puff.setAttribute('cy',200); puff.setAttribute('r',8);
  puff.setAttribute('fill','rgba(200,200,200,0.18)');
  svg.appendChild(puff);
  let t=0;
  const id = setInterval(()=>{
    t+=1; puff.setAttribute('r',8+t*6); puff.setAttribute('fill','rgba(200,200,200,'+Math.max(0,0.18-(t*0.02))+')');
    if (t>12){ clearInterval(id); puff.remove(); }
  },30);
}

// test button
document.getElementById('startBtn').addEventListener('click', async ()=>{
  await enableMic();
  document.getElementById('startBtn').disabled = true;
  document.getElementById('startBtn').textContent = 'Microphone enabled';
});

// simulate blow via click
document.getElementById('testBlow').addEventListener('click', ()=>{
  // briefly pretend to detect high RMS
  if (!isExtinguished) triggerBlow();
});

// Reset by clicking cake area (for testing)
cakeWrap.addEventListener('click', ()=>{
  if (!isExtinguished) return;
  isExtinguished = false;
  svg.classList.remove('extinguished');
  const flames = svg.querySelectorAll('.flame');
  flames.forEach((f)=>{ f.style.opacity='1'; f.style.transform='translateY(0) scale(1)'; });
  const smokes = svg.querySelectorAll('.smoke');
  smokes.forEach((s)=>{ s.style.opacity='0'; s.setAttribute('ry',6); s.setAttribute('rx',2); });
});

// Accessibility: keyboard test
window.addEventListener('keydown', (e)=>{ if (e.key === 'b') document.getElementById('testBlow').click(); });

// Note: this is a client-side demo. To make this "sendable" (i.e. someone receives a link with lit candles), you can upload this file to GitHub Pages or Netlify. If you want I can add a tiny serverless state store (via gist or URL param) to mark candles as lit for a recipient.
</script>
</body>
</html>
